generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id                  String                     @id @default(cuid())
  name                String
  email               String?                    @unique
  code                String                     @unique
  status              String                     @default("draft")
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  location            String?
  password            String?
  settings            SchoolSettings?
  teams               Team[]
  templateAssignments TemplateSchoolAssignment[]
  templates           TournamentTemplate[]
  tournaments         Tournament[]
  users               User[]

  @@map("schools")
}

model TournamentTemplate {
  id              String                     @id @default(cuid())
  name            String
  description     String?
  version         String                     @default("1.0.0")
  isOfficial      Boolean                    @default(false)
  isActive        Boolean                    @default(true)
  createdBy       String?
  schoolId        String?
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  config          Json
  changelog       Json?
  assignedSchools TemplateSchoolAssignment[]
  school          School?                    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  tournaments     Tournament[]

  @@map("tournament_templates")
}

model TemplateSchoolAssignment {
  id         String             @id @default(cuid())
  templateId String
  schoolId   String
  assignedAt DateTime           @default(now())
  assignedBy String?
  school     School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  template   TournamentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, schoolId])
  @@map("template_school_assignments")
}

model Tournament {
  id                String               @id @default(cuid())
  schoolId          String
  name              String
  code              String               @unique
  description       String?
  status            String               @default("draft")
  isActive          Boolean              @default(true)
  templateId        String?
  templateVersion   String?
  startDate         DateTime?
  endDate           DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  rankingMethod     String               @default("percentage")
  weights           Json?
  tieBreak          Json?
  allowReevaluation Boolean              @default(true)
  configLocked      Boolean              @default(false)
  features          Json?
  icon              String?
  evaluations       Evaluation[]
  snapshots         RankingSnapshot[]
  areas             TournamentArea[]
  teams             TournamentTeam[]
  school            School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  template          TournamentTemplate?  @relation(fields: [templateId], references: [id])
  userAreas         UserTournamentArea[]

  @@map("tournaments")
}

model TournamentArea {
  id                String               @id @default(cuid())
  tournamentId      String
  name              String
  code              String
  description       String?
  weight            Float                @default(1.0)
  order             Int                  @default(0)
  scoringType       String
  rubricConfig      Json?
  performanceConfig Json?
  aggregationMethod String               @default("last")
  timeLimit         Int?
  timeAction        String               @default("alert")
  allowRounds       Boolean              @default(false)
  maxRounds         Int                  @default(1)
  roundsAggregation String?
  penaltyLimits     Json?
  hasPrice          Boolean              @default(false)
  priceConfig       Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  evaluations       Evaluation[]
  tournament        Tournament           @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  assignedJudges    UserTournamentArea[]

  @@map("tournament_areas")
}

model User {
  id               String               @id @default(cuid())
  schoolId         String?
  name             String
  email            String               @unique
  password         String
  role             String
  isAdmin          Boolean              @default(false)
  areas            String[]
  isActive         Boolean              @default(true)
  isFirstLogin     Boolean              @default(true)
  lastLoginAt      DateTime?
  sessionExpiresAt DateTime?
  tempPassword     String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  evaluations      Evaluation[]
  assignedAreas    UserTournamentArea[]
  school           School?              @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("users")
}

model UserTournamentArea {
  id           String         @id @default(cuid())
  userId       String
  tournamentId String
  areaId       String
  createdAt    DateTime       @default(now())
  area         TournamentArea @relation(fields: [areaId], references: [id], onDelete: Cascade)
  tournament   Tournament     @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tournamentId, areaId])
  @@map("user_tournament_areas")
}

model Team {
  id          String           @id @default(cuid())
  name        String
  code        String?
  metadata    Json?
  grade       String?
  shift       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  schoolId    String?
  evaluations Evaluation[]
  school      School?          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  tournaments TournamentTeam[]

  @@map("teams")
}

model TournamentTeam {
  id           String     @id @default(cuid())
  tournamentId String
  teamId       String
  createdAt    DateTime   @default(now())
  team         Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, teamId])
  @@map("tournament_teams")
}

model Evaluation {
  id                 String         @id @default(cuid())
  tournamentId       String
  teamId             String
  areaId             String
  round              Int            @default(1)
  scores             Json
  comments           String?
  evaluationTime     Int
  evaluatedById      String
  evaluatedAt        DateTime       @default(now())
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  version            Int            @default(1)
  isActive           Boolean        @default(true)
  isSynced           Boolean        @default(true)
  syncVersion        Int            @default(0)
  syncedAt           DateTime       @default(now())
  idempotencyKey     String?        @unique
  parentEvaluationId String?
  area               TournamentArea @relation(fields: [areaId], references: [id], onDelete: Cascade)
  evaluatedBy        User           @relation(fields: [evaluatedById], references: [id])
  parentEvaluation   Evaluation?    @relation("EvaluationHistory", fields: [parentEvaluationId], references: [id])
  childEvaluations   Evaluation[]   @relation("EvaluationHistory")
  team               Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  tournament         Tournament     @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  penalties          Penalty[]

  @@unique([tournamentId, teamId, areaId, evaluatedById, round])
  @@index([teamId, areaId])
  @@index([isSynced])
  @@index([isActive])
  @@map("evaluations")
}

model Penalty {
  id           String     @id @default(cuid())
  evaluationId String
  type         String
  points       Int
  description  String?
  createdAt    DateTime   @default(now())
  evaluation   Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  @@map("penalties")
}

model PlatformConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt

  @@map("platform_config")
}

model SchoolSettings {
  id        String   @id @default(cuid())
  schoolId  String   @unique
  language  String   @default("pt-BR")
  branding  Json?
  updatedAt DateTime @updatedAt
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("school_settings")
}

model RankingSnapshot {
  id           String     @id @default(cuid())
  tournamentId String
  event        String
  rankings     Json
  metadata     Json?
  createdAt    DateTime   @default(now())
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@index([tournamentId])
  @@map("ranking_snapshots")
}
